```shell
# 1. 统计指定进程当前打开的文件描述符数量
ls /proc/pid/fd | wc -l
# 2. 查看指定进程的「最大打开文件数」限制
cat /proc/pid/limits | grep "Max open files"
# 3. 统计系统全局所有打开的文件总数
lsof 2>/dev/null| wc -l
# 4. 统计 systemd-journald 服务进程打开的文件数
lsof -p $(pidof systemd-journald) 2>/dev/null| wc -l
# 5. 列出打开文件最多的前 10 个进程及其 PID
lsof 2>/dev/null | awk '{print $1,$2}' | sort | uniq -c | sort -nr | head
# 6. 查看系统文件句柄的三个关键参数：已分配/未使用/最大值
cat /proc/sys/fs/file-nr 
# 7. 显示系统级最大文件句柄数限制
cat /proc/sys/fs/file-max
# 8. 显示系统允许的最大线程数
cat /proc/sys/kernel/threads-max
# 9. 检查 systemd-journald 进程的文件打开限制
cat /proc/$(pidof systemd-journald)/limits | grep "Max open files"
# 10. 查看 systemd 服务的文件描述符限制
systemctl show <service_name> | grep LimitNOFILE
# 11. 显示当前 Shell 的硬限制文件打开数
ulimit -Hn || sysctl -a|grep vm.max_map_count
# 12. 检查当前inotify限制
sysctl fs.inotify.{max_user_instances,max_user_watches}
find /proc/*/fd/* -type l -lname 'anon_inode:inotify' 2>/dev/null | wc -l
sysctl fs.file-max
sysctl vm.max_map_count

#系统级限制 (file-max) > 用户级限制 (ulimit) > 进程级限制 (/proc/pid/limits)
 

# 查看进程内存占用&日志
ps aux --sort=-%mem | head -n 10
journalctl -u rsync
tail /var/log/syslog 
tail /var/log/kern.log
dmesg | less || dmesg -T | grep -i oom
tail /var/log/boot.log
journalctl --since "2025-04-10" --until "2025-04-11"
grep -Ei 'too many open files|ulimit|file descriptor' /var/log/*

#调优方案
#===用户进程级===
#调大文件描述符数量后，系统要：
#使用更多内存管理 FD 表（每个 FD 占用一些内存，也就意味着吃内存，但不会立刻占用内存）
#FD 数越多，某些系统调用可能变慢
#ulimit -n 2048 #临时设置当前会话的文件描述符
#vim /etc/security/limits.conf #永久设置文件描述符限制(重启生效)
* soft nproc 655360 #所有用户的最大进程数 
* hard nproc 655360 #所有用户的最大进程数
root soft nofile 1048576 # root的软限制(许多发行版 * 不包含root)
* soft nofile 1048576 # 所有用户的最大打开文件数 软限制
* hard nofile 1048576 # 所有用户的最大打开文件数 硬限制

#vim /etc/pam.d/common-session ##启用PAM模块使limits生效
session required pam_limits.so

#===内核级===
#sysctl -w fs.file-max=1048576 #临时设置系统最大文件描述符
#sudo nano /etc/sysctl.conf #永久设置内核参数
fs.file-max = 1048576 #系统最大可打开文件数
vm.max_map_count=1048576 #系统允许的内存映射区域数量
fs.inotify.max_user_instances = 1024 #单个用户允许的inotify监听实力例数
fs.inotify.max_user_watches = 524288 #单个用户允许的inotify监听的文件数量
#sudo sysctl -p #加载sysctl配置

#===systemd服务限制===
#设置systemd服务的全局默认限制（影响所有服务）
#sudo nano /etc/systemd/system.conf | /etc/systemd/user.conf
DefaultLimitNOFILE=524288:524288 #设置软/硬限制为524288
 
#systemctl edit docker #设置Docker守护进程的文件描述符限制
[Service]
LimitNOFILE=524288 # 最大文件描述符硬限制 （必须≥容器内设置的值）
LimitNOFILESoft=65536 # 最大文件描述符软限制

#sudo systemctl daemon-reexec # 重新加载systemd配置
#=================================================================================

```
